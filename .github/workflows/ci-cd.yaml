name: CI/CD For test and deploy our application

on:
    push:
        branches:
            - "**"

jobs:
    test:
        name: Test Machine
        runs-on: ubuntu-latest
        if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/dev'

        steps:
            - name: Code checkout on test machine
              uses: actions/checkout@v3

            - name: Setup nodejs
              uses: actions/setup-node@v3
              with:
                  node-version: 20

            - name: Install dependencies
              run: npm install --force

            - name: Run tests
              run: npm run ci:fix

            - name: Build application
              run: npm run build

    build-push:
        name: Build and push image
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/dev'

        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: login to docker hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}
            - name: Setup docker
              uses: docker/setup-docker-action@v4

            - name: build image
              run: |
                  docker build --no-cache -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.PACKAGE }}:latest .
            - name: push image
              run: |
                  docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.PACKAGE }}:latest

    deploy:
        name: deploy to vps
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        steps:
            - name: checkout
              uses: actions/checkout@v3

            - name: Test ssh connection to vps
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      echo "Successfully connected to vps"
                      uptime

            - name: Copy compose file
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  source: "docker-compose.yaml"
                  target: "/home/${{secrets.USERNAME}}/projects/${{secrets.PACKAGE}}"

            - name: Deploy to vps
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      cd ~/projects/${{secrets.PACKAGE}}
                      docker compose --profile prod pull
                      docker compose --profile prod down
                      docker image prune -af
                      docker compose --profile prod up -d --force-recreate
            - name: Restart caddy server
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      sudo systemctl restart caddy
                      echo "Successfully restarted caddy server"
    deploy-check:
        name: Check if deploy was successful
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        needs: [deploy]

        steps:
            - name: login to the vps
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      cd /home/${{secrets.USERNAME}}/projects/${{secrets.PACKAGE}}
                      container_status=$(docker compose --profile prod ps -q) | xargs docker inspect -f-format '{{.State.Status}}' | grep -vE 'exited|restarting'
                      if [[ -z "$container_status"]]; then
                        echo "Error: Containers are not running"
                        exit 1
                      else
                        echo "Containers are running"
                      fi
                      reponsee_code=$(curl --write-out "%{http_code}" --silent --output /dev/null http://localhost:${{secrets.PORT}})/api/health)
                      if [[ "$response_code" -eq 200]]; then
                        echo "Successfully checked if the containers are running"
                      else
                        echo "Error: app is not reponding currently (HTTP status: $response_code)"
                        exit 1
                      fi

    notify:
        name: Notify on failure
        runs-on: ubuntu-latest
        if: |
            always() &&
            (needs.build-push.result == 'failure' ||
            needs.deploy.result == 'failure' ||
            needs.deploy-check.result == 'failure') &&
            (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')

        needs: [build-push, deploy, deploy-check]
        steps:
            - name: send telegram message
              uses: devlopersabbir/telegram-action-notifier@v1.0.1
              with:
                  bot_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
                  chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
                  message: |
                      <b>ðŸš¨ Deployment Failed!</b>
                      Please check logs immediately.
